# План реализации

- [ ] 1. Настройка проекта и базовой инфраструктуры
- [ ] 1.1 Настроить Supabase проект и создать схему базы данных
  - Создать Supabase проект
  - Выполнить SQL миграции для создания всех таблиц
  - Настроить Row Level Security (RLS) политики
  - Настроить Supabase Storage для файлов
  - _Requirements: 10.1, 10.2_

- [ ] 1.2 Установить и настроить зависимости проекта
  - Установить Supabase client, shadcn/ui, Tiptap, Zod, React Hook Form
  - Настроить Tailwind CSS
  - Настроить TypeScript конфигурацию
  - Создать структуру папок проекта
  - _Requirements: All_

- [ ] 1.3 Создать типы данных и схемы валидации
  - Написать TypeScript интерфейсы для всех моделей данных
  - Создать Zod схемы для валидации
  - Настроить типы для Supabase
  - _Requirements: 10.3_

- [ ] 1.4 Настроить тестовую инфраструктуру
  - Установить Vitest и fast-check
  - Настроить React Testing Library
  - Создать тестовые утилиты и моки
  - _Requirements: All_

- [ ] 2. Реализация аутентификации
- [ ] 2.1 Создать компоненты аутентификации
  - Реализовать LoginForm с валидацией
  - Реализовать SignUpForm с валидацией
  - Реализовать ResetPasswordForm
  - Создать AuthProvider для управления состоянием
  - _Requirements: 1.1, 1.2, 1.3, 1.5_


- [ ] 2.2 Реализовать Server Actions для аутентификации
  - Написать signIn, signUp, signOut, resetPassword actions
  - Добавить обработку ошибок
  - Реализовать валидацию на сервере
  - _Requirements: 1.1, 1.2, 1.3, 1.5_

- [ ] 2.3 Написать property тест для аутентификации
  - **Property 1: Создание аккаунта с валидными данными**
  - **Validates: Requirements 1.1**

- [ ] 2.4 Написать property тест для round-trip аутентификации
  - **Property 2: Аутентификация после регистрации**
  - **Validates: Requirements 1.2**

- [ ] 2.5 Написать property тест для отклонения невалидных данных
  - **Property 3: Отклонение невалидных учетных данных**
  - **Validates: Requirements 1.5**

- [ ] 2.6 Создать middleware для защиты маршрутов
  - Реализовать проверку аутентификации
  - Настроить редиректы для неавторизованных пользователей
  - _Requirements: 1.4_

- [ ] 3. Реализация воркспейсов
- [ ] 3.1 Создать компоненты управления воркспейсами
  - Реализовать WorkspaceSelector
  - Создать форму создания воркспейса
  - Реализовать WorkspaceSettings
  - Создать InviteMemberForm
  - Реализовать MemberList
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5_

- [ ] 3.2 Реализовать Server Actions для воркспейсов
  - Написать createWorkspace, inviteMember, removeMember actions
  - Реализовать acceptInvitation, switchWorkspace
  - Добавить проверку прав доступа
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5_

- [ ] 3.3 Написать property тест для владельца воркспейса
  - **Property 4: Создатель воркспейса становится владельцем**
  - **Validates: Requirements 2.1**

- [ ] 3.4 Написать property тест для уникальности токенов
  - **Property 5: Уникальность токенов приглашений**
  - **Validates: Requirements 2.2**

- [ ] 3.5 Написать property тест для принятия приглашений
  - **Property 6: Принятие приглашения добавляет участника**
  - **Validates: Requirements 2.3**

- [ ] 3.6 Написать property тест для удаления участников
  - **Property 7: Удаление участника отзывает доступ**
  - **Validates: Requirements 2.4**

- [ ] 4. Checkpoint - Убедиться что все тесты проходят
  - Ensure all tests pass, ask the user if questions arise.

- [ ] 5. Реализация базы кейсов
- [ ] 5.1 Создать компоненты для кейсов
  - Реализовать CaseList с фильтрацией и поиском
  - Создать CaseCard для отображения
  - Реализовать CaseEditor с формой
  - Создать CaseImageUploader
  - _Requirements: 3.1, 3.2, 3.4, 3.5_

- [ ] 5.2 Реализовать Server Actions для кейсов
  - Написать createCase, updateCase, deleteCase
  - Реализовать getCases с фильтрацией
  - Добавить uploadCaseImage с валидацией файлов
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5_

- [ ] 5.3 Написать property тест для сохранения кейсов
  - **Property 8: Сохранение всех полей кейса**
  - **Validates: Requirements 3.1**

- [ ] 5.4 Написать property тест для обновления кейсов
  - **Property 9: Обновление кейса сохраняет изменения**
  - **Validates: Requirements 3.2**

- [ ] 5.5 Написать property тест для удаления кейсов
  - **Property 10: Удаление кейса делает его недоступным**
  - **Validates: Requirements 3.3**

- [ ] 5.6 Написать property тест для списка кейсов
  - **Property 11: Список кейсов воркспейса полон**
  - **Validates: Requirements 3.4**

- [ ] 5.7 Написать property тест для изображений кейсов
  - **Property 12: Изображения связаны с кейсом**
  - **Validates: Requirements 3.5**

- [ ] 6. Реализация rich-text редактора
- [ ] 6.1 Настроить Tiptap редактор
  - Установить и настроить Tiptap с расширениями
  - Добавить поддержку форматирования (bold, italic, lists)
  - Реализовать вставку ссылок
  - Добавить поддержку заголовков разных уровней
  - _Requirements: 12.1, 12.2, 12.3_

- [ ] 6.2 Создать компонент RichTextEditor
  - Реализовать UI для редактора
  - Добавить тулбар с кнопками форматирования
  - Настроить сохранение в JSON формате
  - _Requirements: 12.1, 12.2, 12.3_

- [ ] 6.3 Написать property тест для сохранения форматирования
  - **Property 35: Сохранение форматирования текста (Round-trip)**
  - **Validates: Requirements 12.1, 12.2, 12.3**

- [ ] 7. Реализация коммерческих предложений
- [ ] 7.1 Создать базовую структуру КП
  - Реализовать ProposalEditor с разделами
  - Создать форму для основной информации (название, клиент)
  - Добавить статусы КП (draft, sent, accepted, rejected)
  - _Requirements: 4.1_

- [ ] 7.2 Реализовать редактор таймлайна
  - Создать TimelineEditor компонент
  - Добавить возможность указать даты начала и окончания
  - Реализовать добавление вех (milestones)
  - _Requirements: 4.2_

- [ ] 7.3 Реализовать редактор оценки команды
  - Создать TeamEstimateEditor компонент
  - Добавить поля для роли, часов, ставки
  - Реализовать автоматический расчет стоимости
  - _Requirements: 4.3_

- [ ] 7.4 Реализовать выбор кейсов
  - Создать CaseSelector компонент
  - Добавить возможность выбора из списка кейсов воркспейса
  - Реализовать превью выбранных кейсов
  - _Requirements: 4.4_

- [ ] 7.5 Реализовать редактор контактов
  - Создать форму для email, телефона, адреса
  - Добавить валидацию контактных данных
  - _Requirements: 4.5_

- [ ] 7.6 Реализовать редактор процессов
  - Интегрировать RichTextEditor для описания процессов
  - _Requirements: 4.6_

- [ ] 7.7 Реализовать редактор технологического стека
  - Создать компонент для добавления технологий
  - Добавить возможность поиска и выбора из списка
  - _Requirements: 4.7_

- [ ] 7.8 Реализовать редактор FAQ
  - Создать компонент для добавления вопросов и ответов
  - Реализовать возможность переупорядочивания
  - _Requirements: 4.8_

- [ ] 7.9 Реализовать редактор платежного календаря
  - Создать PaymentScheduleEditor компонент
  - Добавить поля для даты, суммы, описания
  - Реализовать расчет общей суммы
  - _Requirements: 4.9_

- [ ] 7.10 Реализовать Server Actions для КП
  - Написать createProposal, updateProposal, deleteProposal
  - Реализовать duplicateProposal
  - Добавить getProposals с фильтрацией
  - _Requirements: 4.1-4.9, 9.1-9.5_

- [ ] 7.11 Написать property тест для сохранения данных КП
  - **Property 13: Сохранение данных КП (Round-trip)**
  - **Validates: Requirements 4.1-4.9**

- [ ] 8. Реализация автосохранения
- [ ] 8.1 Создать механизм автосохранения
  - Реализовать autoSaveProposal Server Action
  - Добавить debounce для автосохранения каждые 30 секунд
  - Создать индикатор статуса сохранения
  - _Requirements: 11.1, 11.2, 11.3, 11.4_

- [ ] 8.2 Написать property тест для автосохранения
  - **Property 34: Автосохранение сохраняет данные (Round-trip)**
  - **Validates: Requirements 11.2, 11.3**

- [ ] 9. Checkpoint - Убедиться что все тесты проходят
  - Ensure all tests pass, ask the user if questions arise.

- [ ] 10. Реализация интеграции с Loom
- [ ] 10.1 Создать компонент для встраивания Loom
  - Реализовать LoomEmbedder компонент
  - Добавить парсинг Loom URL
  - Создать iframe для отображения видео
  - _Requirements: 5.1, 5.2, 5.3_

- [ ] 10.2 Добавить управление Loom видео в КП
  - Реализовать добавление/удаление видео
  - Сохранять ссылки в массиве loomVideos
  - _Requirements: 5.1, 5.2_

- [ ] 10.3 Написать property тест для добавления Loom видео
  - **Property 14: Добавление Loom видео**
  - **Validates: Requirements 5.1**

- [ ] 10.4 Написать property тест для удаления Loom видео
  - **Property 15: Удаление Loom видео**
  - **Validates: Requirements 5.2**

- [ ] 11. Реализация превью-контента
- [ ] 11.1 Создать систему прикрепления превью
  - Реализовать PreviewAttachment компонент
  - Добавить возможность прикрепления изображений к тексту
  - Реализовать прикрепление ссылок
  - _Requirements: 8.1, 8.2_

- [ ] 11.2 Реализовать всплывающие окна с превью
  - Создать Popover для отображения превью
  - Добавить триггер на hover
  - _Requirements: 8.3_

- [ ] 11.3 Добавить оптимизацию изображений
  - Использовать Sharp для оптимизации
  - Реализовать автоматическое сжатие при загрузке
  - _Requirements: 8.5_

- [ ] 11.4 Написать property тест для связи превью с текстом
  - **Property 22: Связь превью с текстом**
  - **Validates: Requirements 8.1, 8.2**

- [ ] 11.5 Написать property тест для удаления превью
  - **Property 23: Удаление превью сохраняет текст**
  - **Validates: Requirements 8.4**

- [ ] 11.6 Написать property тест для оптимизации изображений
  - **Property 24: Оптимизация изображений**
  - **Validates: Requirements 8.5**

- [ ] 12. Реализация публичных ссылок
- [ ] 12.1 Создать генератор публичных ссылок
  - Реализовать PublicLinkGenerator компонент
  - Добавить генерацию уникального slug
  - Создать Server Action generatePublicLink
  - _Requirements: 6.1_

- [ ] 12.2 Создать публичную страницу просмотра КП
  - Реализовать PublicProposalView без требования авторизации
  - Создать маршрут /p/[slug]
  - Добавить красивое оформление для клиентов
  - _Requirements: 6.2_

- [ ] 12.3 Реализовать деактивацию ссылок
  - Добавить Server Action deactivatePublicLink
  - Создать UI для управления активностью ссылки
  - _Requirements: 6.4_

- [ ] 12.4 Написать property тест для уникальности ссылок
  - **Property 16: Уникальность публичных ссылок**
  - **Validates: Requirements 6.1**

- [ ] 12.5 Написать property тест для синхронизации изменений
  - **Property 17: Синхронизация изменений с публичной ссылкой**
  - **Validates: Requirements 6.3**

- [ ] 12.6 Написать property тест для деактивации ссылок
  - **Property 18: Деактивация публичной ссылки запрещает доступ**
  - **Validates: Requirements 6.4**

- [ ] 13. Реализация генерации PDF
- [ ] 13.1 Создать PDF шаблон
  - Реализовать PDFTemplate Server Component
  - Создать HTML разметку для всех разделов КП
  - Добавить стили для печати
  - _Requirements: 7.1, 7.2, 7.3, 7.4_

- [ ] 13.2 Настроить Puppeteer для генерации PDF
  - Установить Puppeteer
  - Создать API Route /api/pdf/generate
  - Реализовать рендеринг HTML в PDF
  - _Requirements: 7.1_

- [ ] 13.3 Добавить обработку изображений в PDF
  - Встроить изображения в PDF
  - Оптимизировать размер PDF
  - _Requirements: 7.3_

- [ ] 13.4 Создать UI для скачивания PDF
  - Реализовать PDFDownloadButton
  - Добавить индикатор генерации
  - _Requirements: 7.5_

- [ ] 13.5 Написать property тест для содержимого PDF
  - **Property 19: Генерация PDF содержит все данные**
  - **Validates: Requirements 7.1**

- [ ] 13.6 Написать property тест для изображений в PDF
  - **Property 20: Изображения встроены в PDF**
  - **Validates: Requirements 7.3**

- [ ] 13.7 Написать property тест для доступности PDF
  - **Property 21: PDF доступен для скачивания**
  - **Validates: Requirements 7.5**

- [ ] 13.8 Написать property тест для форматирования в PDF
  - **Property 36: Форматирование в PDF (Round-trip)**
  - **Validates: Requirements 12.4**

- [ ] 14. Checkpoint - Убедиться что все тесты проходят
  - Ensure all tests pass, ask the user if questions arise.

- [ ] 15. Реализация шаблонов КП
- [ ] 15.1 Создать компоненты для шаблонов
  - Реализовать TemplateList
  - Создать TemplateCard с превью
  - Реализовать CreateFromTemplateButton
  - _Requirements: 13.2, 13.5_

- [ ] 15.2 Реализовать Server Actions для шаблонов
  - Написать createTemplate (сохранение КП как шаблона)
  - Реализовать updateTemplate, deleteTemplate
  - Добавить createProposalFromTemplate
  - _Requirements: 13.1, 13.2, 13.3, 13.4_

- [ ] 15.3 Написать property тест для сохранения как шаблона
  - **Property 38: Сохранение КП как шаблона**
  - **Validates: Requirements 13.1**

- [ ] 15.4 Написать property тест для создания из шаблона
  - **Property 39: Создание КП из шаблона (Round-trip)**
  - **Validates: Requirements 13.2**

- [ ] 15.5 Написать property тест для независимости шаблона
  - **Property 40: Независимость шаблона от созданных КП**
  - **Validates: Requirements 13.3**

- [ ] 15.6 Написать property тест для удаления шаблона
  - **Property 41: Удаление шаблона не влияет на КП**
  - **Validates: Requirements 13.4**

- [ ] 15.7 Написать property тест для списка шаблонов
  - **Property 42: Список шаблонов воркспейса полон**
  - **Validates: Requirements 13.5**

- [ ] 16. Реализация системы комментариев
- [ ] 16.1 Создать компоненты для комментариев
  - Реализовать CommentThread
  - Создать CommentForm для добавления
  - Реализовать CommentItem с вложенностью
  - Создать CommentBadge для индикации количества
  - _Requirements: 14.1, 14.2, 14.5_

- [ ] 16.2 Реализовать Server Actions для комментариев
  - Написать createComment с поддержкой parentId
  - Реализовать updateComment, deleteComment
  - Добавить resolveComment
  - Создать getComments с загрузкой вложенных
  - _Requirements: 14.1, 14.2, 14.3, 14.4_

- [ ] 16.3 Написать property тест для сохранения комментариев
  - **Property 43: Сохранение комментария с метаданными**
  - **Validates: Requirements 14.1**

- [ ] 16.4 Написать property тест для вложенных комментариев
  - **Property 44: Вложенные комментарии**
  - **Validates: Requirements 14.2**

- [ ] 16.5 Написать property тест для удаления комментариев
  - **Property 45: Удаление комментария**
  - **Validates: Requirements 14.3**

- [ ] 16.6 Написать property тест для статуса комментариев
  - **Property 46: Изменение статуса комментария**
  - **Validates: Requirements 14.4**

- [ ] 16.7 Написать property тест для подсчета комментариев
  - **Property 47: Подсчет активных комментариев**
  - **Validates: Requirements 14.5**

- [ ] 17. Реализация real-time совместной работы
- [ ] 17.1 Настроить Supabase Realtime
  - Настроить Realtime каналы для КП
  - Создать subscribeToProposalPresence функцию
  - Реализовать broadcastPresence
  - _Requirements: 15.1, 15.3, 15.4_

- [ ] 17.2 Создать компоненты для presence
  - Реализовать ActiveUsers компонент
  - Создать EditingIndicator для разделов
  - Реализовать PresenceProvider контекст
  - _Requirements: 15.3, 15.4_

- [ ] 17.3 Реализовать синхронизацию изменений
  - Настроить subscribeToProposalChanges
  - Добавить обработку конфликтов при одновременном редактировании
  - Реализовать оптимистичные обновления UI
  - _Requirements: 15.1, 15.2_

- [ ] 17.4 Добавить offline-first функциональность
  - Реализовать локальное сохранение изменений
  - Добавить синхронизацию при восстановлении соединения
  - Создать индикатор статуса соединения
  - _Requirements: 15.5_

- [ ] 17.5 Написать property тест для синхронизации без конфликтов
  - **Property 48: Синхронизация изменений без конфликтов**
  - **Validates: Requirements 15.2**

- [ ] 17.6 Написать property тест для списка активных участников
  - **Property 49: Список активных участников**
  - **Validates: Requirements 15.3**

- [ ] 17.7 Написать property тест для индикатора редактирования
  - **Property 50: Индикатор редактирования раздела**
  - **Validates: Requirements 15.4**

- [ ] 18. Реализация списка и управления КП
- [ ] 18.1 Создать ProposalList с фильтрацией
  - Реализовать отображение всех КП воркспейса
  - Добавить фильтрацию по статусу
  - Реализовать поиск по названию
  - _Requirements: 9.1, 9.2, 9.3_

- [ ] 18.2 Написать property тест для списка КП
  - **Property 25: Список КП воркспейса полон**
  - **Validates: Requirements 9.1**

- [ ] 18.3 Написать property тест для фильтрации
  - **Property 26: Фильтрация КП по статусу**
  - **Validates: Requirements 9.2**

- [ ] 18.4 Написать property тест для поиска
  - **Property 27: Поиск КП по названию**
  - **Validates: Requirements 9.3**

- [ ] 18.5 Написать property тест для каскадного удаления
  - **Property 28: Каскадное удаление КП**
  - **Validates: Requirements 9.4**

- [ ] 18.6 Написать property тест для дублирования
  - **Property 29: Дублирование создает независимую копию**
  - **Validates: Requirements 9.5**

- [ ] 19. Реализация безопасности и изоляции данных
- [ ] 19.1 Добавить проверки прав доступа
  - Реализовать middleware для проверки членства в воркспейсе
  - Добавить проверки в Server Actions
  - _Requirements: 10.1, 10.2_

- [ ] 19.2 Написать property тест для проверки прав доступа
  - **Property 30: Проверка прав доступа к воркспейсу**
  - **Validates: Requirements 10.1**

- [ ] 19.3 Написать property тест для изоляции данных
  - **Property 31: Изоляция данных воркспейсов**
  - **Validates: Requirements 10.2**

- [ ] 19.4 Написать property тест для валидации данных
  - **Property 32: Валидация данных перед сохранением**
  - **Validates: Requirements 10.3**

- [ ] 19.5 Написать property тест для проверки файлов
  - **Property 33: Проверка типа и размера файлов**
  - **Validates: Requirements 10.5**

- [ ] 20. Финальная полировка UI
- [ ] 20.1 Создать главную страницу и навигацию
  - Реализовать dashboard с обзором КП
  - Создать навигационное меню
  - Добавить breadcrumbs
  - _Requirements: All_

- [ ] 20.2 Добавить shadcn/ui компоненты
  - Использовать Button, Input, Dialog, Dropdown из shadcn/ui
  - Настроить темы и цвета
  - Добавить toast уведомления
  - _Requirements: All_

- [ ] 20.3 Оптимизировать производительность
  - Добавить lazy loading для тяжелых компонентов
  - Оптимизировать изображения с Next.js Image
  - Настроить кэширование
  - _Requirements: All_

- [ ] 20.4 Добавить обработку ошибок
  - Создать Error Boundaries
  - Добавить fallback UI
  - Реализовать понятные сообщения об ошибках
  - _Requirements: All_

- [ ] 21. Финальный checkpoint - Убедиться что все тесты проходят
  - Ensure all tests pass, ask the user if questions arise.
